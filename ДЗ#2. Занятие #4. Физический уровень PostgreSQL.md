# Физический уровень

## Виртуальная машина

`Так как для обучения и выполнения домашних заданий используется ОС Windows 11 Pro, для создания виртуальных машин будет использоваться компонент Windows - Hyper-V.`

На хосте Hyper-V создадим виртуальную машину со следующими параметрами:

* Имя: [otus-pg] Ubuntu-PG-1;
 <img src="imgs\HomeWork2-01.png" alt="Имя">
* Поколение: 2 (с поддержкой UEFI)
 <img src="imgs\HomeWork2-02.png" alt="Поколение">
* Размер ОЗУ: 4096, динамическое выделение памяти;
 <img src="imgs\HomeWork2-03.png" alt="ОЗУ">
* Количество ЦПУ: 1;
* Сетевой адаптер: с доступом к сети;
 <img src="imgs\HomeWork2-04.png" alt="Сетевой адаптер">
* Параметры диска:
  * Размещение: d:\hyper-V\Virtual Hard Disks\,
  * Размер диска: 256 Гб;
<img src="imgs\HomeWork2-05.png" alt="Параметры диска">
* DVD: iso-образ  
Со старницы загрузок Ubuntu Server получаем ISO образ для установки ОС.  
[Ubuntu 24.04.1 LTS](https://ubuntu.com/download/server).
<img src="imgs\HomeWork2-06.png" alt="iso-образ "> 
* Sucure boot: отключено;
<img src="imgs\HomeWork2-07.png" alt="Sucure boot">

## Ubuntu

Установка производится с опциями по умолчанию, с выбранной доп.опцией SSH-Server.

Имя пользователя и пароль:

* User: pg
* Password: QazQaz!23

### Настройки

Проверим IP адрес, чтобы подключатсья через SSH:

```bash
ip addr
```

Обновляем ОС и компоненты:

```bash
sudo apt update
sudo apt upgrade
```

## PostgreSQL

### Установка

Следуя инструкциям на [сайте](https://www.postgresql.org/download/linux/ubuntu/) разработчика выполняем команды:

1. Автоматически настроим репозитории:

```bash
sudo apt install -y postgresql-common
sudo /usr/share/postgresql-common/pgdg/apt.postgresql.org.sh
```

После успешной отработки скрипта увидим сообщение:

`You can now start installing packages from apt.postgresql.org.`


2. Установим следующие компоненты:

| Компонент | описание|
|---|---|
| postgresql-client-{version}| client libraries and client binaries|
|postgresql-{version}| core database server|

```bash
sudo apt install postgresql-17
```

В ходе установки обратим внимание на следующие строки:

```bash
Setting up postgresql-17 (17.0-1.pgdg24.04+1) ...
Creating new PostgreSQL cluster 17/main ...
/usr/lib/postgresql/17/bin/initdb -D /var/lib/postgresql/17/main --auth-local peer --auth-host scram-sha-256 --no-instructions
The files belonging to this database system will be owned by user "postgres".
This user must also own the server process.

The database cluster will be initialized with locale "en_US.UTF-8".
The default database encoding has accordingly been set to "UTF8".
The default text search configuration will be set to "english".

Data page checksums are disabled.

fixing permissions on existing directory /var/lib/postgresql/17/main ... ok
creating subdirectories ... ok
```

В процессе инсталляции выполнена команда `initdb` и назначены права на каталог с данными `/var/lib/postgresql/17/main`.

Ещё один момент на который стоит обратить внимание - локаль с которой была произведена инициализация. Она соответствует локали ОС `"en_US.UTF-8"`.

### Проверка работы PostgreSQL Server

Выполним:

```bash
sudo -u postgres pg_lsclusters
```

Вывод команды:

```bash
Ver Cluster Port Status Owner    Data directory              Log file
17  main    5432 online postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log
```

Выполним ту же команду в контексте текущего пользователя:

```bash
pg_lsclusters
```

Вывод команды:

```bash
Ver Cluster Port Status Owner    Data directory              Log file
17  main    5432 online postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log
```

Таким образом, выполнение `pg_lsclusters` возможно без указания `-u postgres`.

Проверим наличие PostgreSQL Server в SystemD:

```bash
systemctl status postgresql
```

Вывод команды:

```bash
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; preset: enabled)
     Active: active (exited) since Thu 2024-10-17 18:57:48 UTC; 1h 23min ago
   Main PID: 10344 (code=exited, status=0/SUCCESS)
        CPU: 9ms

Oct 17 18:57:48 ubuntu-pg-1 systemd[1]: Starting postgresql.service - PostgreSQL RDBMS...
Oct 17 18:57:48 ubuntu-pg-1 systemd[1]: Finished postgresql.service - PostgreSQL RDBMS.

```

`postgresql` запускается и управляется  `systemd`, т.е. при установке был создан корректный unit файл, дополнительной конфигурации не требуется.

Попробуем подключиться к кластеру

```bash
psql -U postgres
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "postgres"
```

Отредактируем `pg_hba.conf` для локальных подключений, добавив в конец файла строку:
> local   all             all                                     trust

При этом обязательно нужно закомментировать или удалить строку, созданную в момент инсталляции:
> local   all             all                                     peer

```bash
sudo nano /etc/postgresql/17/main/pg_hba.conf
sudo systemctl restart postgresql
```

Иначе неизбежно подключение будет отклонено:
```bash
~$ psql -U postgres
psql: error: connection to server on socket "/var/run/postgresql/.s.PGSQL.5432" failed: FATAL:  Peer authentication failed for user "postgres"
```


### Данные

Создадим базу, таблицу в ней, несколько строк данных в таблице.

```bash
psql -U postgres
```

Запрос:

```sql
\set AUTOCOMMIT ON -- на всякий случай
CREATE DATABASE OTUS305557;
\c otus305557
create table some_stuff(id serial, first_column text, one_more_column text);
insert into some_stuff(first_column, one_more_column) values('bla-bla-bla', 'ugu-gu');  
insert into some_stuff(first_column, one_more_column) values('mu mu mu', 'be be be');
```

Ответ:

```bash
CREATE TABLE
INSERT 0 1
INSERT 0 1
```

Проверим:

```sql
select * from some_stuff;
```

Вывод:

```bash
  1 | bla-bla-bla  | ugu-gu
  2 | mu mu mu     | be be be
```

## Новый диск

### Настройка в ОС

Новый диск создан на хосте Hyper-V и подключен к VM

```bash
sudo lshw -C disk
  *-disk:0
       description: SCSI Disk
       product: Virtual Disk
       vendor: Msft
       physical id: 0.0.0
       bus info: scsi@0:0.0.0
       logical name: /dev/sda
       version: 1.0
       size: 256GiB (274GB)
       capabilities: gpt-1.00 partitioned partitioned:gpt
       configuration: ansiversion=5 guid=0d8c1013-bdb8-419e-aa88-9d9df4e96558 logicalsectorsize=512 sectorsize=4096
  *-disk:1
       description: SCSI Disk
       product: Virtual Disk
       vendor: Msft
       physical id: 0.0.1
       bus info: scsi@0:0.0.1
       logical name: /dev/sdb
       version: 1.0
       size: 10GiB (10GB)
       configuration: ansiversion=5 logicalsectorsize=512 sectorsize=4096
```

Инициализируем и разметим новый диск:

```bash
sudo parted /dev/sdb
```

```bash
GNU Parted 3.6
Using /dev/sdb
Welcome to GNU Parted! Type 'help' to view a list of commands.
```

```bash
(parted) mklabel gpt
(parted) unit GB
(parted) mkpart
Partition name?  []? 10g
File system type?  [ext2]? ext4
Start? 0
End? 10
(parted)
```

Назначим точку монтирования `/mnt/data/`

```bash
sudo nano -Bw /etc/fstab
```

>/dev/sdb1 /mnt/data/ ext4 defaults 0 2

Перезагрузим сервер, убедиться, что всё настроено корректно:

```bash
sudo reboot
```

После перезагрузки проверим доступность точки монтирования.

```bash
 ls -la /mnt/data/
total 8
drwxr-xr-x 2 root root 4096 Oct 17 21:28 .
drwxr-xr-x 3 root root 4096 Oct 17 21:28 ..
```

### Перенос данных кластера PostgreSQL

Остановим кластер командой `pg_ctlcluster`.  
Для этого нужны версия и имя кластера. Узнаем их:

```bash
pg_lsclusters
```

Останавливаем:

```bash
sudo pg_ctlcluster 17 main stop
```

Проверим:

```bash
pg_lsclusters
Ver Cluster Port Status Owner    Data directory              Log file
17  main    5432 down   postgres /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log

```

И посмотрим на статус через systemctl

```bash
systemctl status postgresql
● postgresql.service - PostgreSQL RDBMS
     Loaded: loaded (/usr/lib/systemd/system/postgresql.service; enabled; preset: enabled)
     Active: active (exited) since Thu 2024-10-17 20:47:18 UTC; 20min ago
    Process: 13047 ExecStart=/bin/true (code=exited, status=0/SUCCESS)
   Main PID: 13047 (code=exited, status=0/SUCCESS)
        CPU: 6ms
```

Кластер остановлен.

Сменим владельца `/mnt/data/`.

```bash
 sudo chown -R postgres:postgres /mnt/data/
```

Проверим:

```bash
ls -la /mnt/data/
total 8
drwxr-xr-x 2 postgres postgres 4096 Oct 17 21:28 .
drwxr-xr-x 3 root     root     4096 Oct 17 21:28 ..
```

Переместим данные:

```bash
sudo mv /var/lib/postgresql/17/ /mnt/data/
```

Проверяем, что данные появились по новому пути

```bash
ls -la /mnt/data/
total 12
drwxr-xr-x 3 postgres postgres 4096 Oct 17 21:36 .
drwxr-xr-x 3 root     root     4096 Oct 17 21:28 ..
drwxr-xr-x 3 postgres postgres 4096 Oct 17 19:07 17
```

и отсутствуют по старому пути

```bash
ls -la /var/lib/postgresql/
total 8
drwxr-xr-x  2 postgres postgres 4096 Oct 17 21:36 .
drwxr-xr-x 46 root     root     4096 Oct 17 19:43 ..
```

Пробуем запустить кластер:

```bash
sudo pg_ctlcluster 17 main start
```

Ожидаемо, по старому пути данные не найдены.

```bash
Error: /var/lib/postgresql/17/main is not accessible or does not exist
```

Изменился вывод команды `pg_lsclusters`

```bash
pg_lsclusters
Ver Cluster Port Status Owner     Data directory              Log file
17  main    5432 down   <unknown> /var/lib/postgresql/17/main /var/log/postgresql/postgresql-17-main.log
```

Теперь в поле `owner`  написано `unknown`.

Укажем новое местоположение файлов данных кластера.

```bash
sudo nano /etc/postgresql/17/main/postgresql.conf
```

Заменим:
>data_directory = '/var/lib/postgresql/17/main'          # use data in another directory

на:

>data_directory = '/mnt/data/17/main'

Пробуем запустить кластер.

```bash
sudo pg_ctlcluster 17 main start
```

Проверяем статус:

```bash
pg_lsclusters
Ver Cluster Port Status Owner    Data directory    Log file
17  main    5432 online postgres /mnt/data/17/main /var/log/postgresql/postgresql-17-main.log
```

Проверяем на месте ли данные.

```bash
psql -U postgres
psql (17.0 (Ubuntu 17.0-1.pgdg24.04+1))
Type "help" for help.
```

Проверим на есть ли база, которую мы создали.

```bash
postgres=# \l
                                                      List of databases
    Name    |  Owner   | Encoding | Locale Provider |   Collate   |    Ctype    | Locale | ICU Rules |   Access privileges
------------+----------+----------+-----------------+-------------+-------------+--------+-----------+-----------------------
 otus305557 | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           |
 postgres   | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           |
 template0  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
            |          |          |                 |             |             |        |           | postgres=CTc/postgres
 template1  | postgres | UTF8     | libc            | en_US.UTF-8 | en_US.UTF-8 |        |           | =c/postgres          +
            |          |          |                 |             |             |        |           | postgres=CTc/postgres
(4 rows)
```

 База на месте. Переключимся на неё. Для проверки таблицы и строк в ней.

```bash
postgres=# \c otus305557
You are now connected to database "otus305557" as user "postgres".
otus305557=#
```

Запрос:

```sql
select * from some_stuff;
```

Вывод:

```bash
  1 | bla-bla-bla  | ugu-gu
  2 | mu mu mu     | be be be
```